<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì˜ì‚´ì•„ë³´ì„¸ | AI íŠœí„°ë§</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #FF6B35;
            --primary-light: #FF8F5E;
            --secondary: #2C5530;
            --success: #4CAF50;
            --warning: #FF9800;
            --danger: #f44336;
            --dark: #1a1a2e;
            --gray: #6c757d;
            --light-gray: #f5f5f5;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, sans-serif;
            background: var(--light-gray);
            min-height: 100vh;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: var(--white);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--dark), #2a2a4e);
            color: var(--white);
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .child-select {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .child-avatar {
            font-size: 24px;
        }

        .child-details h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .child-details p {
            font-size: 12px;
            opacity: 0.8;
        }

        /* Content */
        .content {
            padding: 20px;
        }

        /* Upload Section */
        .upload-section {
            background: var(--white);
            border: 2px dashed #ddd;
            border-radius: 20px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-section:hover,
        .upload-section.dragover {
            border-color: var(--primary);
            background: rgba(255, 107, 53, 0.05);
        }

        .upload-section.has-image {
            padding: 10px;
            border-style: solid;
            border-color: var(--success);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-section h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .upload-section p {
            font-size: 14px;
            color: var(--gray);
        }

        #file-input {
            display: none;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 15px;
            object-fit: contain;
        }

        .image-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--white);
            width: 100%;
            justify-content: center;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--light-gray);
            color: var(--dark);
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 14px;
        }

        /* Detected Worksheet Badge */
        .detected-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .detected-badge .icon {
            font-size: 16px;
        }

        /* Loading State */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: var(--white);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 300px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--light-gray);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-content h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .loading-content p {
            font-size: 14px;
            color: var(--gray);
        }

        /* Result Section */
        .result-section {
            display: none;
        }

        .result-section.active {
            display: block;
        }

        .result-card {
            background: var(--white);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        }

        .score-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .score-circle {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--success), #66BB6A);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--white);
        }

        .score-circle.warning {
            background: linear-gradient(135deg, var(--warning), #FFB74D);
        }

        .score-circle.danger {
            background: linear-gradient(135deg, var(--danger), #EF5350);
        }

        .score-circle .score {
            font-size: 28px;
            font-weight: 700;
        }

        .score-circle .label {
            font-size: 12px;
        }

        .score-info h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .score-info p {
            font-size: 14px;
            color: var(--gray);
        }

        .feedback-item {
            margin-bottom: 20px;
        }

        .feedback-item:last-child {
            margin-bottom: 0;
        }

        .feedback-item h4 {
            font-size: 15px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feedback-text {
            background: var(--light-gray);
            padding: 15px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.7;
            color: #444;
        }

        .next-step-card {
            background: linear-gradient(135deg, var(--secondary), #3d6b40);
            border-radius: 15px;
            padding: 20px;
            color: var(--white);
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .next-step-card:hover {
            transform: translateY(-2px);
        }

        .next-step-icon {
            font-size: 30px;
        }

        .next-step-info h4 {
            font-size: 15px;
            font-weight: 600;
        }

        .next-step-info p {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 3px;
        }

        /* Profile Card */
        .profile-card {
            background: linear-gradient(135deg, var(--dark), #2a2a4e);
            border-radius: 20px;
            padding: 20px;
            color: var(--white);
            margin-bottom: 20px;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-box {
            text-align: center;
        }

        .stat-box .value {
            font-size: 24px;
            font-weight: 700;
        }

        .stat-box .label {
            font-size: 11px;
            opacity: 0.8;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: var(--light-gray);
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--white);
            color: var(--dark);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* History List */
        .history-item {
            background: var(--white);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        }

        .history-icon {
            width: 45px;
            height: 45px;
            background: var(--light-gray);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .history-info {
            flex: 1;
        }

        .history-info h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
        }

        .history-info p {
            font-size: 12px;
            color: var(--gray);
        }

        .history-score {
            text-align: right;
        }

        .history-score .score {
            font-size: 16px;
            font-weight: 700;
            color: var(--success);
        }

        .history-score .date {
            font-size: 11px;
            color: var(--gray);
        }

        /* Skills Section */
        .skill-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .skill-name {
            width: 80px;
            font-size: 13px;
            color: var(--dark);
        }

        .skill-bar {
            flex: 1;
            height: 10px;
            background: var(--light-gray);
            border-radius: 10px;
            overflow: hidden;
        }

        .skill-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .skill-fill.high {
            background: var(--success);
        }

        .skill-fill.medium {
            background: var(--warning);
        }

        .skill-fill.low {
            background: var(--danger);
        }

        .skill-percent {
            width: 40px;
            text-align: right;
            font-size: 13px;
            font-weight: 600;
            color: var(--dark);
        }

        /* Responsive */
        @media (max-width: 500px) {
            .container {
                max-width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-top">
                <div class="logo">ì˜ì‚´ì•„ë³´ì„¸ ğŸŒ±</div>
                <div class="user-info">
                    <span id="total-worksheets">0</span>ì¥ ì™„ë£Œ
                </div>
            </div>
            <div class="child-select">
                <span class="child-avatar">ğŸ‘§</span>
                <div class="child-details">
                    <h3 id="child-name">Sol</h3>
                    <p>5í•™ë…„ â€¢ Phase <span id="current-phase">1</span></p>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="content">
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="scan">ğŸ“¸ ìŠ¤ìº”</button>
                <button class="tab-btn" data-tab="history">ğŸ“Š ê¸°ë¡</button>
                <button class="tab-btn" data-tab="profile">ğŸ‘¤ í”„ë¡œí•„</button>
            </div>

            <!-- SCAN TAB -->
            <div class="tab-content active" id="tab-scan">

                <!-- Upload Section -->
                <div class="upload-section" id="upload-area">
                    <input type="file" id="file-input" accept="image/*" capture="environment">
                    <div id="upload-placeholder">
                        <div class="upload-icon">ğŸ“·</div>
                        <h3>ì›Œí¬ì‹œíŠ¸ ì‚¬ì§„ ì˜¬ë¦¬ê¸°</h3>
                        <p>í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸í•´ì„œ ì—…ë¡œë“œ</p>
                    </div>
                    <div id="preview-container" style="display: none;">
                        <img id="preview-image" class="preview-image" src="" alt="Preview">
                        <div class="image-actions">
                            <button class="btn btn-secondary btn-small" id="change-image">ğŸ”„ ë‹¤ì‹œ ì°ê¸°</button>
                        </div>
                    </div>
                </div>

                <!-- Analyze Button -->
                <button class="btn btn-primary" id="analyze-btn" disabled>
                    ğŸ¤– AI ë¶„ì„í•˜ê¸°
                </button>

                <!-- Result Section -->
                <div class="result-section" id="result-section">
                    <div class="result-card">
                        <div class="score-header">
                            <div class="score-circle" id="result-score-circle">
                                <span class="score" id="result-score">4</span>
                                <span class="label">/ 5ì </span>
                            </div>
                            <div class="score-info">
                                <h3 id="result-worksheet-name">B-M-E Story Structure</h3>
                                <p id="result-date">ì˜¤ëŠ˜</p>
                            </div>
                        </div>

                        <div class="feedback-item">
                            <h4>ğŸ’ª ì˜í•œ ì </h4>
                            <div class="feedback-text" id="result-strengths">
                                Loading...
                            </div>
                        </div>

                        <div class="feedback-item">
                            <h4>ğŸ“ˆ ê°œì„ í•  ì </h4>
                            <div class="feedback-text" id="result-improvements">
                                Loading...
                            </div>
                        </div>
                    </div>

                    <div class="next-step-card" id="next-step-card">
                        <div class="next-step-icon">ğŸ“</div>
                        <div class="next-step-info">
                            <h4 id="next-worksheet-name">ë‹¤ìŒ ì›Œí¬ì‹œíŠ¸ ì¤€ë¹„ë¨!</h4>
                            <p>íƒ­í•´ì„œ ìƒˆ ì›Œí¬ì‹œíŠ¸ ìŠ¤ìº”í•˜ê¸° â†’</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HISTORY TAB -->
            <div class="tab-content" id="tab-history">
                <div id="history-list">
                    <!-- History items will be added dynamically -->
                    <div style="text-align: center; padding: 40px; color: var(--gray);">
                        ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”.<br>ì²« ì›Œí¬ì‹œíŠ¸ë¥¼ ìŠ¤ìº”í•´ë³´ì„¸ìš”!
                    </div>
                </div>
            </div>

            <!-- PROFILE TAB -->
            <div class="tab-content" id="tab-profile">
                <div class="profile-card">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="font-size: 40px;">ğŸ‘§</span>
                        <div>
                            <h3 style="font-size: 20px; font-weight: 700;" id="profile-name">Sol</h3>
                            <p style="opacity: 0.8; font-size: 14px;">5í•™ë…„ â€¢ NJ ë¶ë¶€</p>
                        </div>
                    </div>
                    <div class="profile-stats">
                        <div class="stat-box">
                            <div class="value" id="stat-total">0</div>
                            <div class="label">ì™„ë£Œ ì›Œí¬ì‹œíŠ¸</div>
                        </div>
                        <div class="stat-box">
                            <div class="value" id="stat-avg">-</div>
                            <div class="label">í‰ê·  ì ìˆ˜</div>
                        </div>
                        <div class="stat-box">
                            <div class="value" id="stat-streak">0ì¼</div>
                            <div class="label">ì—°ì† í•™ìŠµ</div>
                        </div>
                    </div>
                </div>

                <div class="result-card">
                    <h4 style="margin-bottom: 20px; font-size: 16px;">ğŸ“Š ìŠ¤í‚¬ë³„ ì§„ë„</h4>
                    <div id="skills-container">
                        <div class="skill-item">
                            <span class="skill-name">B-M-E</span>
                            <div class="skill-bar">
                                <div class="skill-fill high" id="skill-bme" style="width: 0%"></div>
                            </div>
                            <span class="skill-percent" id="skill-bme-pct">0%</span>
                        </div>
                        <div class="skill-item">
                            <span class="skill-name">SWBST</span>
                            <div class="skill-bar">
                                <div class="skill-fill medium" id="skill-swbst" style="width: 0%"></div>
                            </div>
                            <span class="skill-percent" id="skill-swbst-pct">0%</span>
                        </div>
                        <div class="skill-item">
                            <span class="skill-name">Main Idea</span>
                            <div class="skill-bar">
                                <div class="skill-fill high" id="skill-main-idea" style="width: 0%"></div>
                            </div>
                            <span class="skill-percent" id="skill-main-idea-pct">0%</span>
                        </div>
                        <div class="skill-item">
                            <span class="skill-name">Character</span>
                            <div class="skill-bar">
                                <div class="skill-fill low" id="skill-character" style="width: 0%"></div>
                            </div>
                            <span class="skill-percent" id="skill-character-pct">0%</span>
                        </div>
                    </div>
                </div>

                <div class="result-card">
                    <h4 style="margin-bottom: 15px; font-size: 16px;">ğŸ’ª ê°•ì </h4>
                    <div class="feedback-text" id="profile-strengths">
                        ì•„ì§ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì•„ìš”.
                    </div>
                </div>

                <div class="result-card">
                    <h4 style="margin-bottom: 15px; font-size: 16px;">ğŸ“ˆ ê°œì„  ì¤‘</h4>
                    <div class="feedback-text" id="profile-improvements">
                        ì•„ì§ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì•„ìš”.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>AI ë¶„ì„ ì¤‘...</h3>
            <p>ì›Œí¬ì‹œíŠ¸ ìœ í˜•ì„ ê°ì§€í•˜ê³  í”¼ë“œë°±ì„ ì¤€ë¹„í•˜ê³  ìˆì–´ìš”</p>
        </div>
    </div>

    <script>
        // ============ STATE MANAGEMENT ============
        const state = {
            selectedWorksheet: 'bme',
            uploadedImage: null,
            profile: JSON.parse(localStorage.getItem('jalsal_profile')) || {
                name: 'Sol',
                history: [],
                skills: {
                    'bme': { total: 0, score: 0 },
                    'swbst': { total: 0, score: 0 },
                    'main-idea': { total: 0, score: 0 },
                    'character': { total: 0, score: 0 }
                },
                strengths: [],
                improvements: []
            }
        };

        const worksheetNames = {
            'bme': 'B-M-E Story Structure',
            'swbst': 'SWBST Summary',
            'main-idea': 'Main Idea Detective',
            'character': 'Character Analysis'
        };

        // ============ DOM ELEMENTS ============
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const uploadPlaceholder = document.getElementById('upload-placeholder');
        const previewContainer = document.getElementById('preview-container');
        const previewImage = document.getElementById('preview-image');
        const analyzeBtn = document.getElementById('analyze-btn');
        const resultSection = document.getElementById('result-section');
        const loadingOverlay = document.getElementById('loading-overlay');

        // ============ EVENT LISTENERS ============

        // Tab Navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
            });
        });

        // Auto-detect worksheet type from image
        function detectWorksheetType() {
            // In production, this would be done by AI analyzing the image
            // For now, we randomly pick one to simulate detection
            const types = ['bme', 'swbst', 'main-idea', 'character'];
            return types[Math.floor(Math.random() * types.length)];
        }

        // Upload Area Click
        uploadArea.addEventListener('click', () => {
            if (!state.uploadedImage) {
                fileInput.click();
            }
        });

        // File Input Change
        fileInput.addEventListener('change', handleFileSelect);

        // Drag and Drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handleFile(file);
            }
        });

        // Change Image Button
        document.getElementById('change-image').addEventListener('click', (e) => {
            e.stopPropagation();
            resetUpload();
            fileInput.click();
        });

        // Analyze Button
        analyzeBtn.addEventListener('click', analyzeWorksheet);

        // Next Step Card
        document.getElementById('next-step-card').addEventListener('click', () => {
            resetUpload();
            resultSection.classList.remove('active');
        });

        // ============ FUNCTIONS ============

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                state.uploadedImage = e.target.result;
                previewImage.src = e.target.result;
                uploadPlaceholder.style.display = 'none';
                previewContainer.style.display = 'block';
                uploadArea.classList.add('has-image');
                analyzeBtn.disabled = false;
                resultSection.classList.remove('active');
            };
            reader.readAsDataURL(file);
        }

        function resetUpload() {
            state.uploadedImage = null;
            fileInput.value = '';
            uploadPlaceholder.style.display = 'block';
            previewContainer.style.display = 'none';
            uploadArea.classList.remove('has-image');
            analyzeBtn.disabled = true;
        }

        async function analyzeWorksheet() {
            loadingOverlay.classList.add('active');

            // Simulate AI analysis (replace with real API call)
            await new Promise(resolve => setTimeout(resolve, 2500));

            // Auto-detect worksheet type from image
            state.selectedWorksheet = detectWorksheetType();

            // Generate feedback based on detected worksheet type
            const feedback = generateFeedback(state.selectedWorksheet);

            // Update result UI
            document.getElementById('result-score').textContent = feedback.score;
            document.getElementById('result-worksheet-name').textContent = worksheetNames[state.selectedWorksheet];
            document.getElementById('result-date').textContent = 'ì˜¤ëŠ˜';
            document.getElementById('result-strengths').textContent = feedback.strengths;
            document.getElementById('result-improvements').textContent = feedback.improvements;

            // Update score circle color
            const scoreCircle = document.getElementById('result-score-circle');
            scoreCircle.classList.remove('warning', 'danger');
            if (feedback.score < 3) scoreCircle.classList.add('danger');
            else if (feedback.score < 4) scoreCircle.classList.add('warning');

            // Save to history
            saveToHistory(feedback);

            // Show result
            loadingOverlay.classList.remove('active');
            resultSection.classList.add('active');

            // Scroll to result
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        function generateFeedback(worksheetType) {
            // In production, this would call OpenAI Vision API
            const feedbackTemplates = {
                'bme': {
                    strengths: [
                        'Beginning ë¶€ë¶„ì—ì„œ ì£¼ì¸ê³µê³¼ ë°°ê²½ì„ ì •í™•íˆ íŒŒì•…í–ˆì–´ìš”! ì´ì•¼ê¸°ì˜ ì‹œì‘ì ì„ ì˜ ì´í•´í•˜ê³  ìˆë„¤ìš”.',
                        'End ë¶€ë¶„ì—ì„œ ë¬¸ì œ í•´ê²° ê³¼ì •ì„ ëª…í™•í•˜ê²Œ ì„¤ëª…í–ˆì–´ìš”. ê²°ë§ì˜ ì˜ë¯¸ë¥¼ ì˜ íŒŒì•…í–ˆë„¤ìš”!',
                        'ê° ë¶€ë¶„ì„ ë¶„ë¦¬í•´ì„œ ìƒê°í•˜ëŠ” ëŠ¥ë ¥ì´ ë›°ì–´ë‚˜ìš”. ì´ì•¼ê¸° êµ¬ì¡° íŒŒì•…ì´ ì˜ ë˜ê³  ìˆì–´ìš”.'
                    ],
                    improvements: [
                        'Middle ë¶€ë¶„ì—ì„œ ê°ˆë“±ì„ ì¡°ê¸ˆ ë” ìì„¸íˆ ì„¤ëª…í•˜ë©´ ì¢‹ê² ì–´ìš”. ì£¼ì¸ê³µì´ ì™œ í˜ë“¤ì—ˆëŠ”ì§€, ì–´ë–¤ ê°ì •ì„ ëŠê¼ˆëŠ”ì§€ ì¶”ê°€í•´ë³´ì„¸ìš”.',
                        'Beginningê³¼ Endì˜ ì—°ê²°ì„ ë” ëª…í™•íˆ í•´ë³´ì„¸ìš”. ì£¼ì¸ê³µì´ ì–´ë–»ê²Œ ë³€í™”í–ˆëŠ”ì§€ ìƒê°í•´ë³´ë©´ ì¢‹ê² ì–´ìš”.',
                        'ë¬¸ì¥ì„ ì™„ì„±í˜•ìœ¼ë¡œ ì“°ë©´ ë” ì¢‹ì„ ê²ƒ ê°™ì•„ìš”. ì£¼ì–´ì™€ ë™ì‚¬ë¥¼ ëª…í™•í•˜ê²Œ ì¨ë³´ì„¸ìš”.'
                    ]
                },
                'swbst': {
                    strengths: [
                        'Somebody(ëˆ„ê°€)ì™€ Wanted(ì›í–ˆë‹¤)ë¥¼ ì •í™•íˆ íŒŒì•…í–ˆì–´ìš”! ì£¼ì¸ê³µì˜ ëª©í‘œë¥¼ ì˜ ì´í•´í•˜ê³  ìˆë„¤ìš”.',
                        'But(í•˜ì§€ë§Œ) ë¶€ë¶„ì—ì„œ ë¬¸ì œ ìƒí™©ì„ ì˜ ì°¾ì•„ëƒˆì–´ìš”. ì´ì•¼ê¸°ì˜ í•µì‹¬ ê°ˆë“±ì„ íŒŒì•…í•˜ëŠ” ëŠ¥ë ¥ì´ ì¢‹ì•„ìš”!',
                        'ì „ì²´ ìš”ì•½ì´ ë…¼ë¦¬ì ìœ¼ë¡œ ì—°ê²°ë˜ì–´ ìˆì–´ìš”. SWBST ìˆœì„œëŒ€ë¡œ ì˜ ì •ë¦¬í–ˆë„¤ìš”.'
                    ],
                    improvements: [
                        'So(ê·¸ë˜ì„œ)ì™€ Then(ê·¸ ë‹¤ìŒ) ë¶€ë¶„ì„ ë” êµ¬ì²´ì ìœ¼ë¡œ ì¨ë³´ì„¸ìš”. í•´ê²° ê³¼ì •ì„ ìì„¸íˆ ì„¤ëª…í•˜ë©´ ì¢‹ê² ì–´ìš”.',
                        'í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•  ë•Œ ëª¨ë“  ìš”ì†Œë¥¼ í¬í•¨ì‹œì¼œë³´ì„¸ìš”. ì—°ê²°ì–´(because, so, then)ë¥¼ í™œìš©í•˜ë©´ ì¢‹ì•„ìš”.',
                        'Wanted ë¶€ë¶„ì—ì„œ ì£¼ì¸ê³µì˜ ê°ì •ë„ í•¨ê»˜ ì¨ë³´ë©´ ë” í’ë¶€í•œ ìš”ì•½ì´ ë  ê±°ì˜ˆìš”.'
                    ]
                },
                'main-idea': {
                    strengths: [
                        'ê¸€ì˜ ì£¼ì œ(Topic)ë¥¼ ì •í™•íˆ íŒŒì•…í–ˆì–´ìš”! í•µì‹¬ í‚¤ì›Œë“œë¥¼ ì˜ ì°¾ì•„ëƒˆë„¤ìš”.',
                        'ì„¸ë¶€ ì‚¬í•­(Details)ê³¼ ì¤‘ì‹¬ ìƒê°(Main Idea)ì„ êµ¬ë¶„í•˜ëŠ” ëŠ¥ë ¥ì´ ë›°ì–´ë‚˜ìš”.',
                        'ì¤‘ì‹¬ ìƒê°ì„ ì™„ì „í•œ ë¬¸ì¥ìœ¼ë¡œ ì˜ í‘œí˜„í–ˆì–´ìš”. ê¸€ì˜ í•µì‹¬ ë©”ì‹œì§€ë¥¼ ì´í•´í•˜ê³  ìˆë„¤ìš”!'
                    ],
                    improvements: [
                        'ì„¸ë¶€ ì‚¬í•­ì„ ë” ë‹¤ì–‘í•˜ê²Œ ì°¾ì•„ë³´ì„¸ìš”. ê¸€ì—ì„œ 3ê°œ ì´ìƒì˜ êµ¬ì²´ì ì¸ ì˜ˆì‹œë¥¼ ì°¾ì„ ìˆ˜ ìˆì–´ìš”.',
                        'ì¤‘ì‹¬ ìƒê°ê³¼ ì„¸ë¶€ ì‚¬í•­ì˜ ê´€ê³„ë¥¼ ë” ëª…í™•íˆ ì—°ê²°í•´ë³´ì„¸ìš”. \"ì™œ\"ë¼ëŠ” ì§ˆë¬¸ì„ í•´ë³´ë©´ ì¢‹ì•„ìš”.',
                        'Topicê³¼ Main Ideaì˜ ì°¨ì´ë¥¼ ê¸°ì–µí•˜ì„¸ìš”. Topicì€ ë‹¨ì–´, Main IdeaëŠ” ì™„ì „í•œ ë¬¸ì¥ì´ì—ìš”.'
                    ]
                },
                'character': {
                    strengths: [
                        'ì¸ë¬¼ì˜ íŠ¹ì„±(Traits)ì„ ì—¬ëŸ¬ ê°œ ì°¾ì•„ëƒˆì–´ìš”! í…ìŠ¤íŠ¸ì—ì„œ ê·¼ê±°ë¥¼ ì˜ ì°¾ê³  ìˆë„¤ìš”.',
                        'ì¸ë¬¼ì˜ ë³€í™”(Character Change)ë¥¼ ì˜ íŒŒì•…í–ˆì–´ìš”. ì²˜ìŒê³¼ ëì˜ ì°¨ì´ë¥¼ ì´í•´í•˜ê³  ìˆì–´ìš”.',
                        'ì¸ë¬¼ì˜ í–‰ë™ê³¼ ê°ì •ì„ ì—°ê²°í•´ì„œ ë¶„ì„í–ˆì–´ìš”. ê¹Šì´ ìˆëŠ” ì´í•´ë ¥ì´ ë³´ì—¬ìš”!'
                    ],
                    improvements: [
                        'Evidence(ì¦ê±°)ë¥¼ ì°¾ì„ ë•Œ ì •í™•í•œ ì¸ìš©ì„ ì¨ë³´ì„¸ìš”. ê¸€ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¨ ë¬¸ì¥ì„ ì‚¬ìš©í•˜ë©´ ì¢‹ì•„ìš”.',
                        'ì¸ë¬¼ì˜ ê°ì • ë³€í™” ì´ìœ ë¥¼ ë” ìì„¸íˆ ë¶„ì„í•´ë³´ì„¸ìš”. \"ì™œ ë³€í–ˆì„ê¹Œ?\"ë¼ëŠ” ì§ˆë¬¸ì„ í•´ë³´ì„¸ìš”.',
                        'ë‹¤ë¥¸ ì¸ë¬¼ê³¼ì˜ ê´€ê³„ê°€ ì£¼ì¸ê³µì—ê²Œ ì–´ë–¤ ì˜í–¥ì„ ì¤¬ëŠ”ì§€ë„ ìƒê°í•´ë³´ë©´ ì¢‹ê² ì–´ìš”.'
                    ]
                }
            };

            const template = feedbackTemplates[worksheetType];
            const score = Math.floor(Math.random() * 2) + 3.5; // 3.5-4.5 range
            const roundedScore = Math.round(score * 2) / 2; // Round to 0.5

            return {
                score: roundedScore,
                strengths: template.strengths[Math.floor(Math.random() * template.strengths.length)],
                improvements: template.improvements[Math.floor(Math.random() * template.improvements.length)]
            };
        }

        function saveToHistory(feedback) {
            const entry = {
                id: Date.now(),
                worksheet: state.selectedWorksheet,
                name: worksheetNames[state.selectedWorksheet],
                score: feedback.score,
                strengths: feedback.strengths,
                improvements: feedback.improvements,
                date: new Date().toISOString()
            };

            state.profile.history.unshift(entry);

            // Update skill scores
            const skill = state.profile.skills[state.selectedWorksheet];
            skill.total++;
            skill.score = ((skill.score * (skill.total - 1)) + feedback.score) / skill.total;

            // Save to localStorage
            localStorage.setItem('jalsal_profile', JSON.stringify(state.profile));

            // Update UI
            updateProfileUI();
            updateHistoryUI();
        }

        function updateProfileUI() {
            const profile = state.profile;
            const totalWorksheets = profile.history.length;
            const avgScore = totalWorksheets > 0
                ? (profile.history.reduce((sum, h) => sum + h.score, 0) / totalWorksheets).toFixed(1)
                : '-';

            document.getElementById('total-worksheets').textContent = totalWorksheets;
            document.getElementById('stat-total').textContent = totalWorksheets;
            document.getElementById('stat-avg').textContent = avgScore;

            // Update skill bars
            Object.keys(profile.skills).forEach(skill => {
                const skillData = profile.skills[skill];
                const percent = skillData.total > 0 ? Math.round((skillData.score / 5) * 100) : 0;
                const bar = document.getElementById(`skill-${skill}`);
                const pct = document.getElementById(`skill-${skill}-pct`);
                if (bar && pct) {
                    bar.style.width = `${percent}%`;
                    pct.textContent = `${percent}%`;

                    bar.classList.remove('high', 'medium', 'low');
                    if (percent >= 70) bar.classList.add('high');
                    else if (percent >= 50) bar.classList.add('medium');
                    else bar.classList.add('low');
                }
            });

            // Update strengths/improvements
            if (profile.history.length > 0) {
                const recentStrengths = profile.history.slice(0, 3).map(h => h.strengths);
                const recentImprovements = profile.history.slice(0, 3).map(h => h.improvements);

                document.getElementById('profile-strengths').innerHTML =
                    'â€¢ ' + recentStrengths[0];
                document.getElementById('profile-improvements').innerHTML =
                    'â€¢ ' + recentImprovements[0];
            }
        }

        function updateHistoryUI() {
            const historyList = document.getElementById('history-list');

            if (state.profile.history.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray);">
                        ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”.<br>ì²« ì›Œí¬ì‹œíŠ¸ë¥¼ ìŠ¤ìº”í•´ë³´ì„¸ìš”!
                    </div>
                `;
                return;
            }

            const icons = {
                'bme': 'ğŸ“–',
                'swbst': 'ğŸ“',
                'main-idea': 'ğŸ”',
                'character': 'ğŸ‘¤'
            };

            historyList.innerHTML = state.profile.history.map(entry => {
                const date = new Date(entry.date);
                const dateStr = formatDate(date);
                const scoreColor = entry.score >= 4 ? 'var(--success)' : entry.score >= 3 ? 'var(--warning)' : 'var(--danger)';

                return `
                    <div class="history-item">
                        <div class="history-icon">${icons[entry.worksheet] || 'ğŸ“'}</div>
                        <div class="history-info">
                            <h4>${entry.name}</h4>
                            <p>${entry.strengths.substring(0, 30)}...</p>
                        </div>
                        <div class="history-score">
                            <div class="score" style="color: ${scoreColor}">${entry.score}/5</div>
                            <div class="date">${dateStr}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatDate(date) {
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) return 'ì˜¤ëŠ˜';
            if (days === 1) return 'ì–´ì œ';
            if (days < 7) return `${days}ì¼ ì „`;
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }

        // Initialize
        updateProfileUI();
        updateHistoryUI();
    </script>
</body>

</html>